version: '3.9'

services:
  # ==========================================
  # PostgreSQL Database
  # ==========================================
  db:
    image: postgres:15-alpine
    container_name: techtrace_db
    restart: unless-stopped

    environment:
      POSTGRES_DB: techtrace_db
      POSTGRES_USER: techtrace_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme_secure_password_123}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=es_CL.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      - postgres_data:/var/lib/postgresql/data

    networks:
      - techtrace_network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U techtrace_user -d techtrace_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # Limitar recursos (opcional pero recomendado)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================
  # Django Backend
  # ==========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: techtrace_backend
    restart: unless-stopped

    environment:
      # Django Core
      SECRET_KEY: ${SECRET_KEY:-django-insecure-please-change-this-in-production-use-env-file}
      DEBUG: ${DEBUG:-False}
      ALLOWED_HOSTS: ${ALLOWED_HOSTS:-localhost,backend,nginx}

      # Database (PostgreSQL)
      DATABASE_ENGINE: django.db.backends.postgresql
      DATABASE_NAME: techtrace_db
      DATABASE_USER: techtrace_user
      DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-changeme_secure_password_123}
      DATABASE_HOST: db
      DATABASE_PORT: 5432

      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost}
      CORS_ALLOW_CREDENTIALS: "True"

      # Static & Media
      STATIC_URL: /static/
      STATIC_ROOT: /app/staticfiles
      MEDIA_URL: /media/
      MEDIA_ROOT: /app/media

      # JWT
      JWT_ACCESS_TOKEN_LIFETIME: ${JWT_ACCESS_TOKEN_LIFETIME:-60}
      JWT_REFRESH_TOKEN_LIFETIME: ${JWT_REFRESH_TOKEN_LIFETIME:-7}

      # Internationalization
      LANGUAGE_CODE: es-cl
      TIME_ZONE: America/Santiago
      USE_TZ: "True"

      # Application
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
      MAX_UPLOAD_SIZE: 10
      DEVICE_DEPRECIATION_YEARS: 3

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # Initialization
      CREATE_SUPERUSER: ${CREATE_SUPERUSER:-True}

    volumes:
      - static_files:/app/staticfiles
      - media_files:/app/media

    networks:
      - techtrace_network

    depends_on:
      db:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ==========================================
  # Next.js Frontend
  # ==========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: http://nginx/api
    container_name: techtrace_frontend
    restart: unless-stopped

    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: http://nginx/api
      NEXT_TELEMETRY_DISABLED: 1

    networks:
      - techtrace_network

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M

  # ==========================================
  # Nginx Reverse Proxy
  # ==========================================
  nginx:
    image: nginx:1.25-alpine
    container_name: techtrace_nginx
    restart: unless-stopped

    ports:
      - "80:80"

    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - static_files:/var/www/static:ro
      - media_files:/var/www/media:ro

    networks:
      - techtrace_network

    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

# ==========================================
# Networks
# ==========================================
networks:
  techtrace_network:
    driver: bridge
    name: techtrace_network

# ==========================================
# Volumes
# ==========================================
volumes:
  postgres_data:
    name: techtrace_postgres_data
    driver: local

  static_files:
    name: techtrace_static_files
    driver: local

  media_files:
    name: techtrace_media_files
    driver: local
